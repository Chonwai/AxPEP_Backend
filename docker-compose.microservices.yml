version: '3.8'

services:
  # AmPEP 微服務
  ampep-service:
    image: ampep-microservice:latest
    container_name: ampep-service
    ports:
      - "8001:8001"
    environment:
      - R_LOG_LEVEL=INFO
      - PLUMBER_PORT=8001
      - PLUMBER_HOST=0.0.0.0
    volumes:
      - ./logs/ampep:/app/logs
      - ampep-data:/app/data
    networks:
      - axpep-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1.0'
        reservations:
          memory: 1G
          cpus: '0.5'

  # Laravel 後端 (如果需要一起部署)
  laravel-backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: axpep-backend
    ports:
      - "8000:8000"
    environment:
      - APP_ENV=production
      - AMPEP_MICROSERVICE_BASE_URL=http://ampep-service:8001
      - USE_AMPEP_MICROSERVICE=true
      - AMPEP_MICROSERVICE_TIMEOUT=3600
    volumes:
      - ./storage:/var/www/html/storage
      - ./logs/laravel:/var/www/html/storage/logs
    networks:
      - axpep-network
    depends_on:
      ampep-service:
        condition: service_healthy
    restart: unless-stopped

  # Redis (用於隊列)
  redis:
    image: redis:7-alpine
    container_name: axpep-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - axpep-network
    restart: unless-stopped

  # MySQL 數據庫
  mysql:
    image: mysql:8.0
    container_name: axpep-mysql
    ports:
      - "3306:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=your_root_password
      - MYSQL_DATABASE=axpep_backend
      - MYSQL_USER=axpep_user
      - MYSQL_PASSWORD=your_password
    volumes:
      - mysql-data:/var/lib/mysql
      - ./database/init:/docker-entrypoint-initdb.d
    networks:
      - axpep-network
    restart: unless-stopped

  # Nginx 反向代理 (可選)
  nginx:
    image: nginx:alpine
    container_name: axpep-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    networks:
      - axpep-network
    depends_on:
      - laravel-backend
      - ampep-service
    restart: unless-stopped

networks:
  axpep-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  ampep-data:
    driver: local
  redis-data:
    driver: local
  mysql-data:
    driver: local
